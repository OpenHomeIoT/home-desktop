"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _ConnectionBufferDatabase = _interopRequireDefault(require("../db/ConnectionBufferDatabase"));

var _DeviceOnlineOfflineHistoryDatabase = _interopRequireDefault(require("../db/DeviceOnlineOfflineHistoryDatabase"));

var _DeviceManager = _interopRequireDefault(require("./DeviceManager"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class DeviceStatusManager {
  /**
   * @returns {DeviceStatusManager}
   */
  static getInstance() {
    if (DeviceStatusManager._instance === null) {
      DeviceStatusManager._instance = new DeviceStatusManager(_DeviceOnlineOfflineHistoryDatabase.default.getInstance(), _ConnectionBufferDatabase.default.getInstance(), _DeviceManager.default.getInstance());
    }

    return DeviceStatusManager._instance;
  }
  /**
   * 
   * @param {DeviceOnlineOfflineHistoryDatabase} onlineOfflineHistoryDatabase `
   * @param {ConnectionBufferDatabase} reconnectionBufferDatabase 
   * @param {DeviceManager} deviceManager 
   */


  constructor(onlineOfflineHistoryDatabase, reconnectionBufferDatabase, deviceManager) {
    this._onlineOfflineHistoryDatabase = onlineOfflineHistoryDatabase;
    this._reconnectionBufferDatabase = reconnectionBufferDatabase;
    this._deviceManager = deviceManager; // binding

    this.isDeviceReconnecting = this.isDeviceReconnecting.bind(this);
    this.setDeviceHasDisconnected = this.setDeviceHasDisconnected.bind(this);
    this.setDeviceHasReconnected = this.setDeviceHasConnected.bind(this);
    this.setDeviceIsReconnecting = this.setDeviceIsReconnecting.bind(this);
    this._setDeviceIsOnline = this._setDeviceIsOnline.bind(this);
  }
  /**
   * Set that a device has disconnected from the hub.
   * @param {string} usn the device's usn.
   * @returns {Promise<void>}
   */


  setDeviceHasDisconnected(usn) {
    return this._setDeviceIsOnline(usn, false);
  }
  /**
   * Set that a device has reconnected.
   * @param {string} usn the device's usn.
   * @returns {Promise<void>}
   */


  setDeviceHasConnected(usn) {
    return Promise.resolve().then(() => this._setDeviceIsOnline(usn, true)).then(() => this._reconnectionBufferDatabase.delete(usn));
  }
  /**
   * Add a reconnection entry to the database for a device.
   * @param {string} usn the device's usn.
   */


  setDeviceIsReconnecting(usn) {
    const now = Date.now();
    return this._reconnectionBufferDatabase.get(usn).then(reconnectionInfo => {
      if (!reconnectionInfo) return this._reconnectionBufferDatabase.insert({
        usn,
        timeAdded: now
      });
    });
  }
  /**
   * Set a device's online status.
   * @param {string} usn the device's usn.
   * @param {boolean} isOnline the online status.
   */


  _setDeviceIsOnline(usn, isOnline) {
    return Promise.resolve().then(() => this._deviceManager.getDeviceByUsn(usn)).then(iotDevice => {
      if (!isOnline) {
        iotDevice.setLastSeen(Date.now());
      }

      iotDevice.setOnline(isOnline);
      return this._deviceManager.updateDevice(iotDevice);
    }).then(() => this._onlineOfflineHistoryDatabase.insert({
      usn,
      time: Date.now(),
      isOnline
    })).then(() => isOnline ? this.setDeviceIsReconnecting(usn) : Promise.resolve());
  }

}

_defineProperty(DeviceStatusManager, "_instance", null);

var _default = DeviceStatusManager;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRldmljZS9tYW5hZ2VyL0RldmljZVN0YXR1c01hbmFnZXIuanMiXSwibmFtZXMiOlsiRGV2aWNlU3RhdHVzTWFuYWdlciIsImdldEluc3RhbmNlIiwiX2luc3RhbmNlIiwiRGV2aWNlT25saW5lT2ZmbGluZUhpc3RvcnlEYXRhYmFzZSIsIkNvbm5lY3Rpb25CdWZmZXJEYXRhYmFzZSIsIkRldmljZU1hbmFnZXIiLCJjb25zdHJ1Y3RvciIsIm9ubGluZU9mZmxpbmVIaXN0b3J5RGF0YWJhc2UiLCJyZWNvbm5lY3Rpb25CdWZmZXJEYXRhYmFzZSIsImRldmljZU1hbmFnZXIiLCJfb25saW5lT2ZmbGluZUhpc3RvcnlEYXRhYmFzZSIsIl9yZWNvbm5lY3Rpb25CdWZmZXJEYXRhYmFzZSIsIl9kZXZpY2VNYW5hZ2VyIiwiaXNEZXZpY2VSZWNvbm5lY3RpbmciLCJiaW5kIiwic2V0RGV2aWNlSGFzRGlzY29ubmVjdGVkIiwic2V0RGV2aWNlSGFzUmVjb25uZWN0ZWQiLCJzZXREZXZpY2VIYXNDb25uZWN0ZWQiLCJzZXREZXZpY2VJc1JlY29ubmVjdGluZyIsIl9zZXREZXZpY2VJc09ubGluZSIsInVzbiIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsImRlbGV0ZSIsIm5vdyIsIkRhdGUiLCJnZXQiLCJyZWNvbm5lY3Rpb25JbmZvIiwiaW5zZXJ0IiwidGltZUFkZGVkIiwiaXNPbmxpbmUiLCJnZXREZXZpY2VCeVVzbiIsImlvdERldmljZSIsInNldExhc3RTZWVuIiwic2V0T25saW5lIiwidXBkYXRlRGV2aWNlIiwidGltZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxtQkFBTixDQUEwQjtBQUl4Qjs7O0FBR0EsU0FBT0MsV0FBUCxHQUFxQjtBQUNuQixRQUFJRCxtQkFBbUIsQ0FBQ0UsU0FBcEIsS0FBa0MsSUFBdEMsRUFBNEM7QUFDMUNGLE1BQUFBLG1CQUFtQixDQUFDRSxTQUFwQixHQUFnQyxJQUFJ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QVVELE1BQU9RLFFBQUQsR0FBYSxLQUFLYix1QkFBTCxDQUE2QkUsR0FBN0IsQ0FBYixHQUFpREMsT0FBTyxDQUFDQyxPQUFSLEVBVnRELENBQVA7QUFXRDs7QUF2RnVCOztnQkFBcEJ0QixtQixlQUVlLEk7O2VBd0ZOQSxtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDb25uZWN0aW9uQnVmZmVyRGF0YWJhc2UgZnJvbSBcIi4uL2RiL0Nvbm5lY3Rpb25CdWZmZXJEYXRhYmFzZVwiO1xuaW1wb3J0IERldmljZU9ubGluZU9mZmxpbmVIaXN0b3J5RGF0YWJhc2UgZnJvbSBcIi4uL2RiL0RldmljZU9ubGluZU9mZmxpbmVIaXN0b3J5RGF0YWJhc2VcIjtcbmltcG9ydCBEZXZpY2VNYW5hZ2VyIGZyb20gXCIuL0RldmljZU1hbmFnZXJcIjtcblxuY2xhc3MgRGV2aWNlU3RhdHVzTWFuYWdlciB7XG5cbiAgc3RhdGljIF9pbnN0YW5jZSA9IG51bGw7XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtEZXZpY2VTdGF0dXNNYW5hZ2VyfVxuICAgKi9cbiAgc3RhdGljIGdldEluc3RhbmNlKCkge1xuICAgIGlmIChEZXZpY2VTdGF0dXNNYW5hZ2VyLl9pbnN0YW5jZSA9PT0gbnVsbCkge1xuICAgICAgRGV2aWNlU3RhdHVzTWFuYWdlci5faW5zdGFuY2UgPSBuZXcgRGV2aWNlU3RhdHVzTWFuYWdlcihEZXZpY2VPbmxpbmVPZmZsaW5lSGlzdG9yeURhdGFiYXNlLmdldEluc3RhbmNlKCksIENvbm5lY3Rpb25CdWZmZXJEYXRhYmFzZS5nZXRJbnN0YW5jZSgpLCBEZXZpY2VNYW5hZ2VyLmdldEluc3RhbmNlKCkpO1xuICAgIH1cbiAgICByZXR1cm4gRGV2aWNlU3RhdHVzTWFuYWdlci5faW5zdGFuY2U7XG4gIH1cblxuXG4gIC8qKlxuICAgKiBcbiAgICogQHBhcmFtIHtEZXZpY2VPbmxpbmVPZmZsaW5lSGlzdG9yeURhdGFiYXNlfSBvbmxpbmVPZmZsaW5lSGlzdG9yeURhdGFiYXNlIGBcbiAgICogQHBhcmFtIHtDb25uZWN0aW9uQnVmZmVyRGF0YWJhc2V9IHJlY29ubmVjdGlvbkJ1ZmZlckRhdGFiYXNlIFxuICAgKiBAcGFyYW0ge0RldmljZU1hbmFnZXJ9IGRldmljZU1hbmFnZXIgXG4gICAqL1xuICBjb25zdHJ1Y3RvcihvbmxpbmVPZmZsaW5lSGlzdG9yeURhdGFiYXNlLCBcbiAgICAgICAgICAgICAgcmVjb25uZWN0aW9uQnVmZmVyRGF0YWJhc2UsXG4gICAgICAgICAgICAgIGRldmljZU1hbmFnZXIpIHtcbiAgICB0aGlzLl9vbmxpbmVPZmZsaW5lSGlzdG9yeURhdGFiYXNlID0gb25saW5lT2ZmbGluZUhpc3RvcnlEYXRhYmFzZTtcbiAgICB0aGlzLl9yZWNvbm5lY3Rpb25CdWZmZXJEYXRhYmFzZSA9IHJlY29ubmVjdGlvbkJ1ZmZlckRhdGFiYXNlO1xuICAgIHRoaXMuX2RldmljZU1hbmFnZXIgPSBkZXZpY2VNYW5hZ2VyO1xuXG4gICAgLy8gYmluZGluZ1xuICAgIHRoaXMuaXNEZXZpY2VSZWNvbm5lY3RpbmcgPSB0aGlzLmlzRGV2aWNlUmVjb25uZWN0aW5nLmJpbmQodGhpcyk7XG4gICAgdGhpcy5zZXREZXZpY2VIYXNEaXNjb25uZWN0ZWQgPSB0aGlzLnNldERldmljZUhhc0Rpc2Nvbm5lY3RlZC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuc2V0RGV2aWNlSGFzUmVjb25uZWN0ZWQgPSB0aGlzLnNldERldmljZUhhc0Nvbm5lY3RlZC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuc2V0RGV2aWNlSXNSZWNvbm5lY3RpbmcgPSB0aGlzLnNldERldmljZUlzUmVjb25uZWN0aW5nLmJpbmQodGhpcyk7XG5cbiAgICB0aGlzLl9zZXREZXZpY2VJc09ubGluZSA9IHRoaXMuX3NldERldmljZUlzT25saW5lLmJpbmQodGhpcyk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoYXQgYSBkZXZpY2UgaGFzIGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBodWIuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c24gdGhlIGRldmljZSdzIHVzbi5cbiAgICogQHJldHVybnMge1Byb21pc2U8dm9pZD59XG4gICAqL1xuICBzZXREZXZpY2VIYXNEaXNjb25uZWN0ZWQodXNuKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NldERldmljZUlzT25saW5lKHVzbiwgZmFsc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGF0IGEgZGV2aWNlIGhhcyByZWNvbm5lY3RlZC5cbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzbiB0aGUgZGV2aWNlJ3MgdXNuLlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn1cbiAgICovXG4gIHNldERldmljZUhhc0Nvbm5lY3RlZCh1c24pIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAudGhlbigoKSA9PiB0aGlzLl9zZXREZXZpY2VJc09ubGluZSh1c24sIHRydWUpKVxuICAgIC50aGVuKCgpID0+IHRoaXMuX3JlY29ubmVjdGlvbkJ1ZmZlckRhdGFiYXNlLmRlbGV0ZSh1c24pKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSByZWNvbm5lY3Rpb24gZW50cnkgdG8gdGhlIGRhdGFiYXNlIGZvciBhIGRldmljZS5cbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzbiB0aGUgZGV2aWNlJ3MgdXNuLlxuICAgKi9cbiAgc2V0RGV2aWNlSXNSZWNvbm5lY3RpbmcodXNuKSB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICByZXR1cm4gdGhpcy5fcmVjb25uZWN0aW9uQnVmZmVyRGF0YWJhc2UuZ2V0KHVzbilcbiAgICAudGhlbihyZWNvbm5lY3Rpb25JbmZvID0+IHsgXG4gICAgICBpZiAoIXJlY29ubmVjdGlvbkluZm8pIHJldHVybiB0aGlzLl9yZWNvbm5lY3Rpb25CdWZmZXJEYXRhYmFzZS5pbnNlcnQoeyB1c24sIHRpbWVBZGRlZDogbm93IH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBhIGRldmljZSdzIG9ubGluZSBzdGF0dXMuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c24gdGhlIGRldmljZSdzIHVzbi5cbiAgICogQHBhcmFtIHtib29sZWFufSBpc09ubGluZSB0aGUgb25saW5lIHN0YXR1cy5cbiAgICovXG4gIF9zZXREZXZpY2VJc09ubGluZSh1c24sIGlzT25saW5lKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgLnRoZW4oKCkgPT4gdGhpcy5fZGV2aWNlTWFuYWdlci5nZXREZXZpY2VCeVVzbih1c24pKVxuICAgIC50aGVuKGlvdERldmljZSA9PiB7XG4gICAgICBpZiAoIWlzT25saW5lKSB7XG4gICAgICAgIGlvdERldmljZS5zZXRMYXN0U2VlbihEYXRlLm5vdygpKTtcbiAgICAgIH1cbiAgICAgIGlvdERldmljZS5zZXRPbmxpbmUoaXNPbmxpbmUpO1xuICAgICAgcmV0dXJuIHRoaXMuX2RldmljZU1hbmFnZXIudXBkYXRlRGV2aWNlKGlvdERldmljZSk7XG4gICAgfSlcbiAgICAudGhlbigoKSA9PiB0aGlzLl9vbmxpbmVPZmZsaW5lSGlzdG9yeURhdGFiYXNlLmluc2VydCh7IHVzbiwgdGltZTogRGF0ZS5ub3coKSwgaXNPbmxpbmUgfSkpXG4gICAgLnRoZW4oKCkgPT4gKGlzT25saW5lKSA/IHRoaXMuc2V0RGV2aWNlSXNSZWNvbm5lY3RpbmcodXNuKSA6IFByb21pc2UucmVzb2x2ZSgpKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBEZXZpY2VTdGF0dXNNYW5hZ2VyO1xuIl0sImZpbGUiOiJkZXZpY2UvbWFuYWdlci9EZXZpY2VTdGF0dXNNYW5hZ2VyLmpzIn0=
